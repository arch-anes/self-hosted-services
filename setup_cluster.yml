# code: language=ansible

---
- name: Setup cluster
  any_errors_fatal: true
  hosts: all
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
    - name: Setup basic firewall rules
      role: weareinteractive.ufw
      vars:
        ufw_rules:
          - { to_port: 22, proto: tcp, rule: allow, comment: "Allow SSH" }
          - { to_port: 80, proto: tcp, rule: allow, comment: "Allow HTTP" }
          - { to_port: 443, proto: tcp, rule: allow, comment: "Allow HTTPS" }
          - { to_port: 53, proto: any, rule: allow, comment: "Allow DNS" }
      become: yes
      when: not skip_firewall

    - name: Create a VPN mesh network
      role: vpn
      when: not skip_vpn_setup

    - name: Deploy Kubernetes cluster
      role: kubernetes
      vars:
        advertised_address: "{{ private_ip | default(ansible_wg0.ipv4.address) }}"
