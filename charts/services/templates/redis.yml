{{- if .Values.applications.redis.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: redis
  namespace: default
  annotations:
    reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
    reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
    reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "kube-system"
type: Opaque
# stringData:
#   redis-password: "somepassword"

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: redis-operator
  namespace: default
spec:
  chart: redis-operator
  repo: https://ot-container-kit.github.io/helm-charts/
  version: 0.20.0
  targetNamespace: default
  valuesContent: |-
    redisOperator:
      webhook: true
    resources:
      requests:
        memory: 64Mi
        cpu: 500m
      limits:
        memory: 128Mi
        cpu: null
    certificate:
      name: redis-operator-serving-cert
      secretName: redis-operator-webhook-server-cert
    certmanager:
      enabled: true

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: redis-cluster
  namespace: default
spec:
  chart: redis-cluster
  repo: https://ot-container-kit.github.io/helm-charts/
  version: 0.16.5
  targetNamespace: default
  valuesContent: |-
    redisCluster:
      clusterSize: 3
      enableMasterSlaveAntiAffinity: true
      redisSecret:
        secretName: redis
        secretKey: redis-password
      resources:
        requests:
          memory: 128Mi
          cpu: 500m
        limits:
          memory: 256Mi
          cpu: null
    nodeSelector:
      # Schedule onto amd64 to specifically avoid raspberry pi to not wear the SD card
      kubernetes.io/arch: amd64
{{- end }}
