{{- if and (not .Values.disableAllApplications) .Values.applications.postgresql.enabled }}

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: postgres-operator
  namespace: kube-system
spec:
  chart: oci://registry.developers.crunchydata.com/crunchydata/pgo
  version: 5.8.2
  targetNamespace: kube-system
  valuesContent: |-
    relatedImages:
      postgres_17:
        image: ghcr.io/arch-anes/crunchy-postgres:ubi9-17.5-2520
    replicas: 2
    resources:
      controller:
        requests:
          cpu: 500m
          memory: 128Mi
        limits:
          memory: 256Mi

---
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-backup-credentials
  namespace: default
type: Opaque
# stringData:
#   s3.conf: |-
#     [global]
#     repo1-s3-key="some-id"
#     repo1-s3-key-secret="some-key"
#     repo1-cipher-pass="some-encryption-key"

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: postgresql
  namespace: default
spec:
  chart: generic
  repo: https://arch-anes.github.io/charts
  version: 0.2.1
  targetNamespace: default
  failurePolicy: abort # Do not uninstall this chart on failure, otherwise the cluster will be deleted
  # takeOwnership: true
  valuesContent: |-
    objects:
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: postgresql
          namespace: default
        data:
          bootstrap.sql: |
            \c postgres
            \o /tmp/grant_users_public_permissions.sql
            \pset format unaligned
            \pset tuples_only on

            WITH dbs AS (
              SELECT datname AS dbname,
                    regexp_replace(datname, '(_main|_log|_cache)$', '') AS username
              FROM pg_database
              WHERE NOT datistemplate AND datallowconn
            )
            SELECT
              'DO $$ BEGIN ' ||
              'IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = ' || quote_literal(username) || ') THEN ' ||
                'EXECUTE ''ALTER DATABASE ' || quote_ident(dbname) || ' OWNER TO ' || quote_ident(username) || '''; ' ||
              'END IF; END $$;' || E'\n' ||

              '\connect ' || quote_ident(dbname) || E';\n' ||

              'DO $$ BEGIN ' ||
              'IF EXISTS (SELECT 1 FROM pg_roles WHERE rolname = ' || quote_literal(username) || ') THEN ' ||
                'EXECUTE ''ALTER SCHEMA public OWNER TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''GRANT ALL ON SCHEMA public TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO ' || quote_ident(username) || '''; ' ||
                'EXECUTE ''ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON FUNCTIONS TO ' || quote_ident(username) || '''; ' ||
              'END IF; END $$;' || E'\n'
            FROM dbs;
            \o
            \i /tmp/grant_users_public_permissions.sql

            \c immich
            BEGIN;
            CREATE EXTENSION IF NOT EXISTS earthdistance CASCADE;
            CREATE EXTENSION IF NOT EXISTS vector CASCADE;
            CREATE EXTENSION IF NOT EXISTS vchord CASCADE;
            COMMIT;
      - apiVersion: postgres-operator.crunchydata.com/v1beta1
        kind: PostgresCluster
        metadata:
          name: postgresql
          namespace: default
        spec:
          postgresVersion: 17
          instances:
            - name: instance1
              replicas: 3
              # Schedule pods on separate nodes
              affinity:
                podAntiAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    - topologyKey: kubernetes.io/hostname
                      labelSelector:
                        matchLabels:
                          postgres-operator.crunchydata.com/cluster: postgresql
                          postgres-operator.crunchydata.com/instance-set: instance1
              resources:
                requests:
                  cpu: "1000m"
                  memory: "1Gi"
                limits:
                  hugepages-2Mi: "2Gi"
                  memory: "4Gi"
              dataVolumeClaimSpec:
                accessModes:
                - "ReadWriteOnce"
                storageClassName: local-path-ephemeral
                resources:
                  requests:
                    storage: 10Gi
          config:
            parameters:
              password_encryption: scram-sha-256
              max_connections: "1000"
              shared_preload_libraries: "cube,earthdistance,vector,vchord"
          patroni:
            dynamicConfiguration:
              postgresql:
                # https://github.com/CrunchyData/postgres-operator/issues/2534#issuecomment-891202207
                pg_hba:
                  - "hostnossl all all 10.42.0.0/16 scram-sha-256"
                  - "hostnossl all all 10.43.0.0/16 scram-sha-256"
                  - "hostssl all all 10.42.0.0/16 scram-sha-256"
                  - "hostssl all all 10.43.0.0/16 scram-sha-256"
          users:
            - name: postgres
            - name: bazarr
              databases:
                - bazarr
            - name: gotify
              databases:
                - gotify
            - name: immich
              databases:
                - immich
            - name: inventree
              databases:
                - inventree
            - name: kubeclarity
              databases:
                - kubeclarity
            - name: miniflux
              password:
                type: AlphaNumeric
              databases:
                - miniflux
            - name: n8n
              databases:
                - n8n
            - name: netbox
              databases:
                - netbox
            - name: nextcloud
              databases:
                - nextcloud
            - name: obico
              password:
                type: AlphaNumeric
              databases:
                - obico
            - name: pgadmin4
              password:
                type: AlphaNumeric
              databases:
                - pgadmin4
            - name: prowlarr
              databases:
                - prowlarr_log
                - prowlarr_main
            - name: radarr
              databases:
                - radarr_log
                - radarr_main
            - name: readarr
              databases:
                - readarr_cache
                - readarr_log
                - readarr_main
            - name: sonarr
              databases:
                - sonarr_log
                - sonarr_main
            - name: speedtest-tracker
              databases:
                - speedtest-tracker
            - name: tandoor
              databases:
                - tandoor
            {{- .Values.applications.postgresql.additionalUsers | toYaml | nindent 12 }}
          databaseInitSQL:
            name: postgresql
            key: bootstrap.sql
          backups:
            pgbackrest:
              manual:
                repoName: repo1
                options:
                  - --type=full
              global:
                compress-level: '1'
                compress-level-network: '1'
                compress-type: zst
                repo1-s3-uri-style: path # Backblaze support
                repo1-retention-full: "5" # Keep 5 full backups
                repo1-cipher-type: aes-256-cbc
                repo2-retention-full: "2"
              configuration:
                - secret:
                    name: postgresql-backup-credentials
              repos:
                - name: repo1
                  {{- .Values.applications.postgresql.remoteBackupLocation | toYaml | nindent 18 }}
                  schedules:
                    full: "0 0 * * 2" # Every Tuesday at midnight
                    incremental: "15 12 * * *" # Every day at 12:15 PM
                - name: repo2
                  schedules:
                    full: "0 0 * * 1" # Every Monday at midnight
                    incremental: "0 * * * *" # Every hour
                  volume:
                    volumeClaimSpec:
                      accessModes:
                      - "ReadWriteOnce"
                      storageClassName: local-path-persistent
                      resources:
                        requests:
                          storage: 10Gi
{{- end }}
