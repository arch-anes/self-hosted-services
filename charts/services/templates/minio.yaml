{{- if and .Values.primaryTenant (not .Values.disableAllApplications) .Values.applications.minio.enabled }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: minio-operator
  namespace: kube-system
spec:
  chart: operator
  repo: https://operator.min.io
  version: 7.1.1
  targetNamespace: kube-system
  valuesContent: |-
    operator:
      env:
        - name: PROMETHEUS_NAMESPACE
          value: "kube-system"
      resources:
        requests:
          cpu: 1000m
          memory: 256Mi
          ephemeral-storage: 500Mi
        limits:
          memory: 512Mi
{{- end }}

{{- if and (not .Values.disableAllApplications) .Values.applications.minio.enabled }}
# ---
# apiVersion: v1
# kind: Secret
# metadata:
#   name: minio
#   namespace: "{{ .Values.applicationsNamespace }}"
# type: Opaque
# stringData:
#   accessKey: "some_key"
#   secretKey: "some_key"
#   config.env: |
#     export MINIO_ROOT_USER="some_user"
#     export MINIO_ROOT_PASSWORD="some_pass"
#     export MINIO_BROWSER="on"

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: minio
  namespace: "{{ .Values.applicationsNamespace }}"
spec:
  chart: tenant
  repo: https://operator.min.io
  version: 7.1.1
  targetNamespace: "{{ .Values.applicationsNamespace }}"
  valuesContent: |-
    tenant:
      name: minio
      configSecret:
        name: minio
        existingSecret: true
      configuration:
        name: minio
      certificate:
        requestAutoCert: false
      pools:
        - name: pool-0
          servers: 1
          volumesPerServer: 1
          size: 2Ti
          storageClassName: local-path-persistent-namespaced
          nodeSelector:
            # Schedule only on NAS nodes
            nas: "true"
          resources:
            requests:
              cpu: 1000m
              memory: 1Gi
              ephemeral-storage: 500Mi
            limits:
              memory: 2Gi
      metrics:
        enabled: {{ include "metrics.enabled" . }}
      prometheusOperator: {{ include "metrics.enabled" . }}
{{- if or (and .Values.primaryTenant (or .Values.applications.loki.enabled .Values.applications.tempo.enabled)) .Values.applications.stalwart.enabled }}
      buckets:
{{- if and .Values.primaryTenant .Values.applications.loki.enabled }}
        - name: loki-admin
        - name: loki-chunks
        - name: loki-ruler
{{- end }}
{{- if and .Values.primaryTenant .Values.applications.tempo.enabled }}
        - name: tempo
{{- end }}
{{- if .Values.applications.stalwart.enabled }}
        - name: stalwart
{{- end }}
{{- end }}
{{- if .Values.applications.authentik.enabled }}
      env:
        - name: MINIO_IDENTITY_OPENID_CONFIG_URL
          value: "https://auth.{{ .Values.fqdn }}/application/o/minio/.well-known/openid-configuration"
        - name: MINIO_IDENTITY_OPENID_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: minio-oidc
              key: client_id
        - name: MINIO_IDENTITY_OPENID_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: minio-oidc
              key: client_secret
        - name: MINIO_IDENTITY_OPENID_DISPLAY_NAME
          value: authentik
        - name: MINIO_IDENTITY_OPENID_CLAIM_NAME
          value: policy
        - name: MINIO_IDENTITY_OPENID_SCOPES
          value: openid,profile,email
{{- end }}
    ingress:
      api:
        enabled: true
        annotations:
            homer.item.excluded: "true"
        tls:
          - secretName: "{{ .Values.fqdn }}-tls"
            hosts:
              - s3.{{ .Values.fqdn }}
        host: s3.{{ .Values.fqdn }}
        path: /
        pathType: Prefix
      console:
        enabled: true
        annotations:
          homer.service.name: Media
          homer.item.name: MinIO
          homer.item.logo: "https://cdn.prod.website-files.com/681c8426519d8db8f867c1e8/68656cb290ee4fa91989c2dc_Brand-Logo%20%E2%9C%85.svg"
        tls:
          - secretName: "{{ .Values.fqdn }}-tls"
            hosts:
              - minio.{{ .Values.fqdn }}
        host: minio.{{ .Values.fqdn }}
        path: /
        pathType: Prefix
{{- if .Values.applications.authentik.enabled }}
    extraResources:
      - |
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: authentik-minio-blueprint
          namespace: "{{ .Values.applicationsNamespace }}"
        data:
          blueprint.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: MinIO OAuth2 Provider
            entries:
              - id: minio-provider
                model: authentik_providers_oauth2.oauth2provider
                identifiers:
                  name: Provider for MinIO
                attrs:
                  authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                  client_type: confidential
                  sub_mode: user_username
                  redirect_uris: 
                    - matching_mode: strict
                      url: "https://minio.{{ .Values.fqdn }}/oauth_callback"
                  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
                  client_id: !File /blueprints/mounted/secret-minio-oidc/client_id
                  client_secret: !File /blueprints/mounted/secret-minio-oidc/client_secret
                  property_mappings:
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
              - id: minio-app
                model: authentik_core.application
                identifiers:
                  slug: minio
                attrs:
                  name: MinIO
                  provider: !KeyOf minio-provider
                  policy_engine_mode: any
      - |
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: minio-oidc
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          refreshPolicy: CreatedOnce
          creationPolicy: Owner
          deletionPolicy: Retain
          target:
            name: minio-oidc
          dataFrom:
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: alphanumerical-password-generator
              rewrite:
                - transform:
                    template: client_id
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: huge-alphanumerical-password-generator
              rewrite:
                - transform:
                    template: client_secret
{{- end }}
{{- end }}
