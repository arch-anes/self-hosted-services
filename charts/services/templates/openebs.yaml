---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: openebs
  namespace: kube-system
spec:
  chart: openebs
  repo: https://openebs.github.io/openebs
  version: 4.3.2
  targetNamespace: kube-system
  failurePolicy: abort # Do not uninstall this chart on failure, otherwise the snapshots will be deleted
  valuesContent: |-
    loki:
      enabled: false
    alloy:
      enabled: false
    engines:
      local:
        lvm:
          enabled: false
        zfs:
          enabled: true
        rawfile:
          enabled: false
      replicated:
        mayastor:
          enabled: {{ .Values.replicatedStorage.enabled }}
    mayastor:
      loki-stack:
        enabled: false
      eventing:
        enabled: false
      obs:
        callhome:
          enabled: false
      etcd:
        nodeSelector:
          kubernetes.io/arch: amd64

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: openebs-three-replicas
provisioner: io.openebs.csi-mayastor
allowVolumeExpansion: true
parameters:
  protocol: nvmf
  repl: "3"

{{- if and .Values.replicatedStorage.enabled (not (.Values.replicatedStorage.nodes | empty)) }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: "mayastor-diskpools"
  namespace: kube-system
spec:
  chart: generic
  repo: https://arch-anes.github.io/charts
  version: 0.2.1
  targetNamespace: kube-system
  valuesContent: |-
    objects:
{{- range .Values.replicatedStorage.nodes }}
      - apiVersion: "openebs.io/v1beta3"
        kind: DiskPool
        metadata:
          name: "{{ . }}-diskpool"
          namespace: kube-system
        spec:
          node: "{{ . }}"
          disks:
            - /dev/zvol/storage/encrypted/mayastor
{{- end }}
{{- end }}
