{{- if and (not .Values.disableAllApplications) .Values.applications.nextcloud.enabled }}
{{- if not .Values.applications.postgresql.enabled }}
{{- fail "Nextcloud requires PostgreSQL to be enabled. Please enable PostgreSQL in your values.yaml" }}
{{- end }}
{{- if not .Values.applications.redis.enabled }}
{{- fail "Nextcloud requires Redis to be enabled. Please enable Redis in your values.yaml" }}
{{- end }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nextcloud
  namespace: "{{ .Values.applicationsNamespace }}"
spec:
  storageClassName: local-path-persistent
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Ti

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: nextcloud
  namespace: "{{ .Values.applicationsNamespace }}"
spec:
  chart: nextcloud
  repo: https://nextcloud.github.io/helm/
  version: 8.3.0
  targetNamespace: "{{ .Values.applicationsNamespace }}"
  valuesContent: |-
    podAnnotations:
      backup.velero.io/backup-volumes: nextcloud-main
    image:
      repository: ghcr.io/arch-anes/nextcloud
      flavor: fpm-alpine
    nginx:
      enabled: true
      resources:
        requests:
          memory: 128Mi
          cpu: 100m
        limits:
          memory: 1Gi
      config:
        headers:
          "Referrer-Policy": "no-referrer"
          "X-Content-Type-Options": "nosniff"
          "X-Frame-Options": "SAMEORIGIN"
          "X-Permitted-Cross-Domain-Policies": "none"
          "X-Robots-Tag": "noindex, nofollow"
          "X-XSS-Protection": "1; mode=block"
        custom: |-
          http2 on;

          # Trust X-Forwarded-For and CF-Connecting-IP headers from proxy
          {{- range (concat .Values.localIpRanges .Values.cloudFlareIpRanges) }}
          set_real_ip_from {{ . }};
          {{- end }}
          real_ip_header CF-Connecting-IP;
          real_ip_recursive on;

          # set max upload size and increase upload timeout:
          client_max_body_size 10G;
          client_body_timeout 300s;
          fastcgi_buffers 64 4K;

          # Increase timeouts for long-running PHP tasks
          fastcgi_read_timeout 300s;
          fastcgi_send_timeout 300s;
          fastcgi_connect_timeout 300s;
    nodeSelector:
      # Schedule only on NAS nodes
      nas: "true"
    resources:
      requests:
        memory: 512Mi
        cpu: 1000m
      limits:
        memory: 3Gi
    persistence:
      enabled: true
      existingClaim: nextcloud
    nextcloud:
      host: nextcloud.{{ .Values.fqdn }}
      trustedDomains:
        - nextcloud.{{ .Values.fqdn }}
      phpConfigs:
        custom-php-config.ini: |
          apc.shm_size=1G
          apc.ttl=7200
          apc.entries_hint=10000
      extraEnv:
        - name: PHP_MEMORY_LIMIT
          value: "2G"
        - name: PHP_OPCACHE_MEMORY_CONSUMPTION
          value: "1G"
        - name: TRUSTED_PROXIES
          value: "127.0.0.1"
        - name: REDIS_HOST
          value: "redis-master"
        - name: REDIS_HOST_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis
              key: redis-password
        - name: SMTP_HOST
          valueFrom:
            secretKeyRef:
              name: smtp
              key: hostname
        - name: SMTP_NAME
          valueFrom:
            secretKeyRef:
              name: smtp
              key: username
        - name: SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: smtp
              key: password
        - name: SMTP_SECURE
          value: "tls"
        - name: SMTP_PORT
          value: "587"
        - name: SMTP_AUTHTYPE
          value: "login"
        - name: MAIL_FROM_ADDRESS
          value: "nextcloud"
        - name: MAIL_DOMAIN
          value: "{{ .Values.fqdn }}"
    internalDatabase:
      enabled: false
    externalDatabase:
      enabled: true
      type: postgresql
      host: postgresql-primary
      database: nextcloud
      existingSecret:
        enabled: true
        secretName: postgresql-pguser-nextcloud
        usernameKey: user
        passwordKey: password
    cronjob:
      enabled: true
      resources:
        requests:
          memory: 128Mi
          cpu: 100m
        limits:
          memory: 1Gi
    ingress:
      enabled: true
      annotations:
        homer.service.name: Media
        homer.item.rank: "2"
        homer.item.logo: "https://github.com/nextcloud/server/raw/0450e47f8dda26d19a0a252ddd5a117fddfa6885/core/img/logo/logo.png"
        homer.item.type: "Nextcloud"
      hosts:
        - host: nextcloud.{{ .Values.fqdn }}
          paths:
            - path: /
      tls:
        - secretName: {{ .Values.fqdn }}-tls
          hosts:
            - nextcloud.{{ .Values.fqdn }}
{{- end }}
