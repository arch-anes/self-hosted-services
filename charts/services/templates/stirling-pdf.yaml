{{- if and (not .Values.disableAllApplications) .Values.applications.stirling_pdf.enabled }}
{{- if not .Values.applications.postgresql.enabled }}
{{- fail "Stirling-PDF requires PostgreSQL to be enabled. Please enable PostgreSQL in your values.yaml" }}
{{- end }}

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: stirling-pdf
  namespace: "{{ .Values.applicationsNamespace }}"
spec:
  chart: oci://oci.trueforge.org/truecharts/stirling-pdf
  version: 8.4.18
  targetNamespace: "{{ .Values.applicationsNamespace }}"
  valuesContent: |-
    workload:
      main:
        annotations:
          reloader.stakater.com/auto: "true"
          backup.velero.io/backup-volumes: custom-files
        podSpec:
          containers:
            main:
              imageSelector: fatImage
              env:
                DISABLE_ADDITIONAL_FEATURES: "false"
                DOCKER_ENABLE_SECURITY: "true"
                SYSTEM_ENABLEANALYTICS: "false"
                SYSTEM_ENABLEPOSTHOG: "false"
                SYSTEM_ENABLESCARF: "false"
                SECURITY_ENABLE_LOGIN: "true"
{{- if .Values.applications.authentik.enabled }}
                SECURITY_LOGINMETHOD: oauth2
                SECURITY_OAUTH2_ENABLED: "true"
                SECURITY_OAUTH2_AUTOCREATEUSER: "true"
                SECURITY_OAUTH2_PROVIDER: authentik
                SECURITY_OAUTH2_ISSUER: https://auth.{{ .Values.fqdn }}/application/o/stirling-pdf/
                SECURITY_OAUTH2_CLIENTID:
                  secretKeyRef:
                    name: stirling-pdf
                    key: client_id
                    expandObjectName: false
                SECURITY_OAUTH2_CLIENTSECRET:
                  secretKeyRef:
                    name: stirling-pdf
                    key: client_secret
                    expandObjectName: false
                SECURITY_OAUTH2_USEASUSERNAME: "preferred_username"
                SECURITY_OAUTH2_SCOPES: "openid,profile,email"
{{- else }}
                SECURITY_INITIALLOGIN_USERNAME: admin
                SECURITY_INITIALLOGIN_PASSWORD:
                  secretKeyRef:
                    name: stirling-pdf
                    key: admin_password
                    expandObjectName: false
{{- end }}
    resources:
      requests:
        memory: 1Gi
        cpu: 500m
      limits:
        memory: 2Gi
        cpu: null
    global:
      traefik:
        fixedMiddlewares: []
    ingress:
      main:
        enabled: true
        annotations:    
          homer.service.name: Media
          homer.item.logo: "https://raw.githubusercontent.com/Stirling-Tools/Stirling-PDF/2acb3aa6e5dd8534233e234ce8af1da38e0373ed/docs/stirling.svg"
        hosts:
          - host: pdf.{{ .Values.fqdn }}
            paths:
              - path: /
        tls:
          - secretName: "{{ .Values.fqdn }}-tls"
            hosts:
              - pdf.{{ .Values.fqdn }}
    persistence:
      configs:
        enabled: true
        type: pvc
        storageClass: local-path-persistent-namespaced
      tessdata:
        enabled: true
        type: pvc
        storageClass: local-path-ephemeral
      custom-files:
        enabled: true
        type: pvc
        storageClass: local-path-persistent-namespaced
      logs:
        enabled: false
    configmap:
      authentik-blueprint:
        enabled: {{ .Values.applications.authentik.enabled }}
        data:
          blueprint.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Stirling-PDF OAuth2 Provider
            entries:
              - id: stirling-pdf-provider
                model: authentik_providers_oauth2.oauth2provider
                identifiers:
                  name: Provider for Stirling-PDF
                attrs:
                  authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                  client_type: confidential
                  redirect_uris:
                    - matching_mode: strict
                      url: "https://pdf.{{ .Values.fqdn }}/login/oauth2/code/oidc"
                  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
                  property_mappings:
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
              - id: stirling-pdf-app
                model: authentik_core.application
                identifiers:
                  slug: stirling-pdf
                attrs:
                  name: Stirling-PDF
                  provider: !KeyOf stirling-pdf-provider
                  policy_engine_mode: any
    extraTpl:
      - |
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: stirling-pdf
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          refreshPolicy: CreatedOnce
          creationPolicy: Owner
          deletionPolicy: Retain
          target:
            name: stirling-pdf
          dataFrom:
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: ascii-password-generator
              rewrite:
                - transform:
                    template: admin_password
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: alphanumerical-password-generator
              rewrite:
                - transform:
                    template: client_id
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: huge-alphanumerical-password-generator
              rewrite:
                - transform:
                    template: client_secret
{{- end }}
