{{- if and (not .Values.disableAllApplications) .Values.applications.authentik.enabled }}
{{- if not .Values.applications.postgresql.enabled }}
{{- fail "Authentik requires PostgreSQL to be enabled. Please enable PostgreSQL in your values.yaml" }}
{{- end }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: authentik
  namespace: "{{ .Values.applicationsNamespace }}"
spec:
  chart: authentik
  repo: https://charts.goauthentik.io/
  version: 2026.2.0
  targetNamespace: "{{ .Values.applicationsNamespace }}"
  valuesContent: |-
    global:
      env:
        - name: AUTHENTIK_COOKIE_DOMAIN
          value: "{{ .Values.fqdn }}"
        - name: AUTHENTIK_ERROR_REPORTING__ENABLED
          value: "false"
        - name: AUTHENTIK_POSTGRESQL__HOST
          value: "postgresql-primary"
        - name: AUTHENTIK_POSTGRESQL__NAME
          value: "authentik"
        - name: AUTHENTIK_POSTGRESQL__USER
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-pguser-authentik
              key: password
        - name: AUTHENTIK_POSTGRESQL__SSLMODE
          value: verify-full
        - name: AUTHENTIK_POSTGRESQL__SSLROOTCERT
          value: /etc/postgres/tls/ca.crt
        - name: AUTHENTIK_POSTGRESQL__SSLCERT
          value: /etc/postgres/tls/tls.crt
        - name: AUTHENTIK_POSTGRESQL__SSLKEY
          value: /etc/postgres/tls/tls.key
        - name: AUTHENTIK_EMAIL__HOST
          valueFrom:
            secretKeyRef:
              name: smtp
              key: hostname
        - name: AUTHENTIK_EMAIL__USERNAME
          valueFrom:
            secretKeyRef:
              name: smtp
              key: username
        - name: AUTHENTIK_EMAIL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: smtp
              key: password
        - name: AUTHENTIK_EMAIL__USE_TLS
          value: "true"
        - name: AUTHENTIK_EMAIL__PORT
          value: "587"
        - name: AUTHENTIK_EMAIL__FROM
          value: "no-reply@{{ .Values.fqdn }}"
      volumeMounts:
        - name: postgresql-certs
          mountPath: /etc/postgres/tls
      volumes:
        - name: postgresql-certs
          secret:
            secretName: postgresql-cluster-cert
            defaultMode: 0400
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 1000
      affinity:
        podAntiAffinity: hard
      deploymentStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 50%
      nodeSelector:
        kubernetes.io/arch: amd64
    server:
      deploymentAnnotations:
        reloader.stakater.com/auto: "true"
      replicas: {{ include "ha.replicas" . }}
      resources:
        requests:
          memory: 512Mi
          cpu: 250m
        limits:
          memory: 2Gi
      ingress:
        enabled: true
        annotations:
          homer.service.name: Administration
          homer.item.name: Authentik
          homer.item.logo: "https://raw.githubusercontent.com/goauthentik/authentik/c91c97178f5f3915d60ff50040588771143fd98d/web/icons/icon.png"
        hosts:
          - auth.{{ .Values.fqdn }}
        tls:
          - secretName: "{{ .Values.fqdn }}-tls"
            hosts:
              - auth.{{ .Values.fqdn }}
      metrics:
        enabled: {{ include "metrics.enabled" . }}
        serviceMonitor:
          enabled: {{ include "metrics.enabled" . }}
    worker:
      deploymentAnnotations:
        reloader.stakater.com/auto: "true"
      resources:
        requests:
          memory: 512Mi
          cpu: 1000m
        limits:
          memory: 2Gi
      metrics:
        enabled: {{ include "metrics.enabled" . }}
        serviceMonitor:
          enabled: {{ include "metrics.enabled" . }}
    authentik:
      enabled: false # Disable secret generation
    postgresql:
      enabled: false
    blueprints:
      configMaps:
        - authentik-ldap-blueprint
        - authentik-extra-blueprints
        - authentik-traefik-forward-auth
{{- if .Values.applications.home_assistant.enabled }}
        - authentik-home-assistant-blueprint
{{- end }}
{{- if .Values.applications.immich.enabled }}
        - immich-authentik-blueprint
{{- end }}
{{- if .Values.applications.minio.enabled }}
        - authentik-minio-blueprint
{{- end }}
{{- if .Values.applications.nextcloud.enabled }}
        - authentik-nextcloud-blueprint
{{- end }}
{{- if .Values.applications.stalwart.enabled }}
        - authentik-stalwart-blueprint
{{- end }}
{{- if and .Values.applications.wakapi.enabled (not .Values.applications.wakapi.trusted_header_auth) }}
        - wakapi-authentik-blueprint
{{- end }}
      secrets:
        - ldap
{{- if .Values.applications.home_assistant.enabled }}
        - home-assistant-oidc
{{- end }}
{{- if .Values.applications.immich.enabled }}
        - immich
{{- end }}
{{- if .Values.applications.minio.enabled }}
        - minio-oidc
{{- end }}
{{- if .Values.applications.nextcloud.enabled }}
        - nextcloud-oidc
{{- end }}
{{- if and .Values.applications.wakapi.enabled (not .Values.applications.wakapi.trusted_header_auth) }}
        - wakapi
{{- end }}
    additionalObjects:
      - apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: authentik
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          refreshPolicy: CreatedOnce
          creationPolicy: Owner
          deletionPolicy: Retain
          target:
            name: authentik
          dataFrom:
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: huge-ascii-password-generator
              rewrite:
                - transform:
                    template: "AUTHENTIK_SECRET_KEY"
      - apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ldap
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          refreshPolicy: CreatedOnce
          creationPolicy: Owner
          deletionPolicy: Retain
          target:
            name: ldap
          dataFrom:
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: alphanumerical-password-generator
              rewrite:
                - transform:
                    template: "bind_password"
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: authentik-extra-blueprints
          namespace: "{{ .Values.applicationsNamespace }}"
        data:
          change-password-policy.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Password policy
            entries:
              - identifiers:
                  name: default-password-change-password-policy
                model: authentik_policies_password.passwordpolicy
                attrs:
                  name: default-password-change-password-policy
                  password_field: password
                  length_min: 14
                  amount_uppercase: 1
                  amount_lowercase: 1
                  amount_digits: 1
                  amount_symbols: 1
                  check_static_rules: true
                  check_have_i_been_pwned: true
                  check_zxcvbn: true
                  zxcvbn_score_min: 3
          email-recovery-blueprint.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Recovery with email verification
            entries:
              - identifiers:
                  slug: default-recovery-flow
                id: flow
                model: authentik_flows.flow
                attrs:
                  name: Default recovery flow
                  title: Reset your password
                  designation: recovery
                  authentication: require_unauthenticated
              - identifiers:
                  name: default-recovery-field-password
                id: prompt-field-password
                model: authentik_stages_prompt.prompt
                attrs:
                  field_key: password
                  label: Password
                  type: password
                  required: true
                  placeholder: Password
                  order: 0
                  placeholder_expression: false
              - identifiers:
                  name: default-recovery-field-password-repeat
                id: prompt-field-password-repeat
                model: authentik_stages_prompt.prompt
                attrs:
                  field_key: password_repeat
                  label: Password (repeat)
                  type: password
                  required: true
                  placeholder: Password (repeat)
                  order: 1
                  placeholder_expression: false
              - identifiers:
                  name: default-recovery-skip-if-restored
                id: default-recovery-skip-if-restored
                model: authentik_policies_expression.expressionpolicy
                attrs:
                  expression: |
                    return bool(request.context.get('is_restored', True))
              - identifiers:
                  name: default-recovery-email
                id: default-recovery-email
                model: authentik_stages_email.emailstage
                attrs:
                  use_global_settings: true
                  timeout: 10
                  token_expiry: minutes=30
                  subject: authentik
                  template: email/password_reset.html
                  activate_user_on_success: true
                  recovery_max_attempts: 5
                  recovery_cache_timeout: minutes=5
              - identifiers:
                  name: default-recovery-user-write
                id: default-recovery-user-write
                model: authentik_stages_user_write.userwritestage
                attrs:
                  user_creation_mode: never_create
              - identifiers:
                  name: default-recovery-identification
                id: default-recovery-identification
                model: authentik_stages_identification.identificationstage
                attrs:
                  user_fields:
                    - email
                    - username
              - identifiers:
                  name: default-recovery-user-login
                id: default-recovery-user-login
                model: authentik_stages_user_login.userloginstage
              - identifiers:
                  name: Change your password
                id: stages-prompt-password
                model: authentik_stages_prompt.promptstage
                attrs:
                  fields:
                    - !KeyOf prompt-field-password
                    - !KeyOf prompt-field-password-repeat
                  validation_policies:
                    - !Find [authentik_policies_password.passwordpolicy, [name, default-password-change-password-policy]]
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-recovery-identification
                  order: 10
                model: authentik_flows.flowstagebinding
                id: flow-binding-identification
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: true
                  policy_engine_mode: any
                  invalid_response_action: retry
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-recovery-email
                  order: 20
                model: authentik_flows.flowstagebinding
                id: flow-binding-email
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: true
                  policy_engine_mode: any
                  invalid_response_action: retry
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf stages-prompt-password
                  order: 30
                model: authentik_flows.flowstagebinding
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false
                  policy_engine_mode: any
                  invalid_response_action: retry
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-recovery-user-write
                  order: 40
                model: authentik_flows.flowstagebinding
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false
                  policy_engine_mode: any
                  invalid_response_action: retry
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-recovery-user-login
                  order: 100
                model: authentik_flows.flowstagebinding
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false
                  policy_engine_mode: any
                  invalid_response_action: retry
              - identifiers:
                  policy: !KeyOf default-recovery-skip-if-restored
                  target: !KeyOf flow-binding-identification
                  order: 0
                model: authentik_policies.policybinding
                attrs:
                  negate: false
                  enabled: true
                  timeout: 30
              - identifiers:
                  policy: !KeyOf default-recovery-skip-if-restored
                  target: !KeyOf flow-binding-email
                  order: 0
                state: absent
                model: authentik_policies.policybinding
                attrs:
                  negate: false
                  enabled: true
                  timeout: 30
              - identifiers:
                  name: default-authentication-identification
                model: authentik_stages_identification.identificationstage
                attrs:
                  user_fields:
                    - email
                    - username
                  recovery_flow: !Find [authentik_flows.flow, [slug, default-recovery-flow]]
              - identifiers:
                  domain: authentik-default
                model: authentik_brands.brand
                attrs:
                  flow_recovery: !Find [authentik_flows.flow, [slug, default-recovery-flow]]
          two-factor-login-blueprint.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Two-factor Login
            entries:
              - identifiers:
                  slug: default-authentication-flow
                model: authentik_flows.flow
                id: flow
                attrs:
                  name: Default Authentication Flow
                  title: Welcome to authentik!
                  designation: authentication
                  authentication: require_unauthenticated
              - identifiers:
                  name: test-not-app-password
                id: test-not-app-password
                model: authentik_policies_expression.expressionpolicy
                attrs:
                  expression: |
                    return context.get("auth_method") != "app_password"
              - identifiers:
                  name: default-authentication-login
                id: default-authentication-login
                model: authentik_stages_user_login.userloginstage
              - identifiers:
                  name: default-authentication-identification
                id: default-authentication-identification
                model: authentik_stages_identification.identificationstage
                attrs:
                  user_fields:
                    - email
                    - username
                  template: stages/identification/login.html
              - identifiers:
                  name: default-authentication-flow-mfa
                id: default-authentication-flow-mfa
                model: authentik_stages_authenticator_validate.authenticatorvalidatestage
              - identifiers:
                  name: default-authentication-password
                id: default-authentication-password
                model: authentik_stages_password.passwordstage
                attrs:
                  backends:
                    - authentik.core.auth.InbuiltBackend
                    - authentik.core.auth.TokenBackend
                    - authentik.sources.ldap.auth.LDAPBackend
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-authentication-identification
                  order: 10
                model: authentik_flows.flowstagebinding
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-authentication-password
                  order: 20
                model: authentik_flows.flowstagebinding
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-authentication-flow-mfa
                  order: 30
                model: authentik_flows.flowstagebinding
                id: flow-binding-mfa
                attrs:
                  re_evaluate_policies: true
              - identifiers:
                  target: !KeyOf flow
                  stage: !KeyOf default-authentication-login
                  order: 100
                model: authentik_flows.flowstagebinding
              - identifiers:
                  policy: !KeyOf test-not-app-password
                  target: !KeyOf flow-binding-mfa
                  order: 0
                model: authentik_policies.policybinding
              - identifiers:
                  target: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
                  stage: !Find [authentik_stages_authenticator_validate.authenticatorvalidatestage, [name, default-authentication-mfa-validation]]
                  order: 30
                model: authentik_flows.flowstagebinding
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: true
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: authentik-ldap-blueprint
          namespace: "{{ .Values.applicationsNamespace }}"
        data:
          blueprint.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: LDAP provider app outpost
            entries:
              # ---- Service Account ----
              - id: ldap-bind-user
                model: authentik_core.user
                identifiers:
                  username: ldapservice
                attrs:
                  name: "LDAP Service Account"
                  email: "ldapservice@{{ .Values.fqdn }}"
                  password: !File /blueprints/mounted/secret-ldap/bind_password
                  is_active: true
                  type: service_account

              # ---- Application ----
              - id: ldap-app
                model: authentik_core.application
                identifiers:
                  slug: ldap
                attrs:
                  name: LDAP
                  policy_engine_mode: any

              # ---- Stages ----
              - id: ldap-password
                model: authentik_stages_password.passwordstage
                identifiers:
                  name: "ldap-password"
                attrs:
                  backends:
                    - authentik.core.auth.InbuiltBackend
                    - authentik.core.auth.TokenBackend
                    - authentik.sources.ldap.auth.LDAPBackend
                    - authentik.sources.kerberos.auth.KerberosBackend

              - id: ldap-identification
                model: authentik_stages_identification.identificationstage
                identifiers:
                  name: "ldap-identification"
                attrs:
                  user_fields: ["username", "email"]
                  password_stage: !Find [authentik_stages_password.passwordstage, [name, ldap-password]]

              - id: ldap-user-login
                model: authentik_stages_user_login.userloginstage
                identifiers:
                  name: "ldap-user-login"
                attrs:
                  terminate_other_sessions: false

              # ---- Flows ----
              - id: ldap-auth-flow
                model: authentik_flows.flow
                identifiers:
                  slug: "ldap-authentication-flow"
                attrs:
                  name: "LDAP Authentication"
                  title: "Sign in"
                  designation: authentication
                  require_outpost: true

              # ---- Flow bindings ----
              - id: ldap-auth-flow-bind-ident
                model: authentik_flows.flowstagebinding
                identifiers:
                  target: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
                  stage:  !KeyOf ldap-identification
                  order: 10
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false

              - id: ldap-auth-flow-bind-login
                model: authentik_flows.flowstagebinding
                identifiers:
                  target: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
                  stage:  !KeyOf ldap-user-login
                  order: 30
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false

              # ---- LDAP Provider ----
              - id: ldap-provider
                model: authentik_providers_ldap.ldapprovider
                identifiers:
                  name: "Provider for LDAP"
                attrs:
                  base_dn: "{{ include "ldap.base_dn" . }}"
                  bind_mode: cached
                  search_mode: direct
                  mfa_support: true
                  tls_server_name: ""
                  authorization_flow: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                permissions:
                  - permission: search_full_directory
                    user: !Find [authentik_core.user, [username, ldapservice]]

              # ---- Attach Provider to Application ----
              - id: ldap-app-provider-link
                model: authentik_core.application
                identifiers:
                  slug: ldap
                attrs:
                  provider: !KeyOf ldap-provider

              # ---- LDAP Outpost ----
              - id: ldap-outpost
                model: authentik_outposts.outpost
                identifiers:
                  name: "LDAP outpost"
                attrs:
                  type: ldap
                  providers:
                    - !Find [authentik_providers_ldap.ldapprovider, [name, "Provider for LDAP"]]
                  service_connection: !Find [authentik_outposts.kubernetesserviceconnection, [name, "Local Kubernetes Cluster"]]
                  config:
                    authentik_host: "https://auth.{{ .Values.fqdn }}"
      - apiVersion: v1
        kind: ConfigMap
        metadata:
          name: authentik-traefik-forward-auth
          namespace: "{{ .Values.applicationsNamespace }}"
        data:
          blueprint.yaml: |-
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Traefik forward authentication (domain level)
            entries:
              - id: traefik-forward-domain-provider
                model: authentik_providers_proxy.proxyprovider
                identifiers:
                  name: "Provider for Traefik"
                attrs:
                  mode: forward_domain
                  external_host: "https://auth.{{ .Values.fqdn }}"
                  cookie_domain: ".{{ .Values.fqdn }}"
                  authorization_flow:  !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                  skip_path_regex: ""

              - id: traefik-forward-domain-app
                model: authentik_core.application
                identifiers:
                  name: Traefik
                  slug: traefik
                attrs:
                  provider: !KeyOf traefik-forward-domain-provider

              - model: authentik_outposts.outpost
                identifiers:
                  name: "authentik Embedded Outpost"
                attrs:
                  providers:
                    - !KeyOf traefik-forward-domain-provider
      - apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: authentik-admin
          namespace: "{{ .Values.applicationsNamespace }}"
          annotations:
            homer.item.excluded: "true"
            traefik.ingress.kubernetes.io/router.middlewares: kube-system-intranet-allowlist@kubernetescrd
        spec:
          tls:
            - hosts:
                - auth.{{ .Values.fqdn }}
              secretName: "{{ .Values.fqdn }}-tls"
          rules:
            - host: auth.{{ .Values.fqdn }}
              http:
                paths:
                  - path: /if/admin
                    pathType: Prefix
                    backend:
                      service:
                        name: authentik-server
                        port:
                          number: 80

      - apiVersion: traefik.io/v1alpha1
        kind: Middleware
        metadata:
          name: authentik
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          forwardAuth:
            address: http://ak-outpost-authentik-embedded-outpost.{{ .Values.applicationsNamespace }}.svc.cluster.local:9000/outpost.goauthentik.io/auth/traefik
            trustForwardHeader: true
            authResponseHeaders:
              - X-authentik-username
              - X-authentik-groups
              - X-authentik-entitlements
              - X-authentik-email
              - X-authentik-name
              - X-authentik-uid
              - X-authentik-jwt
              - X-authentik-meta-jwks
              - X-authentik-meta-outpost
              - X-authentik-meta-provider
              - X-authentik-meta-app
              - X-authentik-meta-version
{{- end }}
