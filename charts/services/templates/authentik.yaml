{{- if and (not .Values.disableAllApplications) .Values.applications.authentik.enabled }}
{{- if not .Values.applications.postgresql.enabled }}
{{- fail "Authentik requires PostgreSQL to be enabled. Please enable PostgreSQL in your values.yaml" }}
{{- end }}
---
# Open https://<ingress-host-name>/if/flow/initial-setup/ for the initial setup.
# Note: the trailing / is important.
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: authentik
  namespace: "{{ .Values.applicationsNamespace }}"
spec:
  chart: authentik
  repo: https://charts.goauthentik.io/
  version: 2025.10.0
  targetNamespace: "{{ .Values.applicationsNamespace }}"
  valuesContent: |-
    global:
      env:
        - name: AUTHENTIK_COOKIE_DOMAIN
          value: "{{ .Values.fqdn }}"
        - name: AUTHENTIK_ERROR_REPORTING__ENABLED
          value: "false"
        - name: AUTHENTIK_POSTGRESQL__HOST
          value: "postgresql-primary"
        - name: AUTHENTIK_POSTGRESQL__NAME
          value: "authentik"
        - name: AUTHENTIK_POSTGRESQL__USER
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-pguser-authentik
              key: password
        - name: AUTHENTIK_POSTGRESQL__SSLMODE
          value: verify-full
        - name: AUTHENTIK_POSTGRESQL__SSLROOTCERT
          value: /etc/postgres/tls/ca.crt
        - name: AUTHENTIK_POSTGRESQL__SSLCERT
          value: /etc/postgres/tls/tls.crt
        - name: AUTHENTIK_POSTGRESQL__SSLKEY
          value: /etc/postgres/tls/tls.key
        - name: AUTHENTIK_EMAIL__HOST
          valueFrom:
            secretKeyRef:
              name: smtp
              key: hostname
        - name: AUTHENTIK_EMAIL__USERNAME
          valueFrom:
            secretKeyRef:
              name: smtp
              key: username
        - name: AUTHENTIK_EMAIL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: smtp
              key: password
        - name: AUTHENTIK_EMAIL__USE_TLS
          value: "true"
        - name: AUTHENTIK_EMAIL__PORT
          value: "587"
        - name: AUTHENTIK_EMAIL__FROM
          value: "auth@{{ .Values.fqdn }}"
      volumeMounts:
        - name: postgresql-certs
          mountPath: /etc/postgres/tls
      volumes:
        - name: postgresql-certs
          secret:
            secretName: postgresql-cluster-cert
            defaultMode: 0400
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 1000
      affinity:
        podAntiAffinity: hard
      deploymentStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 50%
      nodeSelector:
        kubernetes.io/arch: amd64
    server:
      deploymentAnnotations:
        reloader.stakater.com/auto: "true"
      replicas: 3
      resources:
        requests:
          memory: 512Mi
          cpu: 250m
        limits:
          memory: 2Gi
      ingress:
        enabled: true
        annotations:
          homer.service.name: Administration
          homer.item.name: Authentik
          homer.item.logo: "https://raw.githubusercontent.com/goauthentik/authentik/c91c97178f5f3915d60ff50040588771143fd98d/web/icons/icon.png"
        hosts:
          - auth.{{ .Values.fqdn }}
        tls:
          - secretName: "{{ .Values.fqdn }}-tls"
            hosts:
              - auth.{{ .Values.fqdn }}
      metrics:
        enabled: {{ include "metrics.enabled" . }}
        serviceMonitor:
          enabled: {{ include "metrics.enabled" . }}
    worker:
      deploymentAnnotations:
        reloader.stakater.com/auto: "true"
      resources:
        requests:
          memory: 512Mi
          cpu: 1000m
        limits:
          memory: 2Gi
      metrics:
        enabled: {{ include "metrics.enabled" . }}
        serviceMonitor:
          enabled: {{ include "metrics.enabled" . }}
    authentik:
      enabled: false # Disable secret generation
    postgresql:
      enabled: false
    blueprints:
      secrets:
        - authentik-blueprints
        - ldap
    additionalObjects:
      - apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: authentik
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          refreshPolicy: CreatedOnce
          creationPolicy: Owner
          deletionPolicy: Retain
          target:
            name: authentik
          dataFrom:
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: huge-ascii-password-generator
              rewrite:
                - transform:
                    template: "AUTHENTIK_SECRET_KEY"
      - apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ldap
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          refreshPolicy: CreatedOnce
          creationPolicy: Owner
          deletionPolicy: Retain
          target:
            name: ldap
          dataFrom:
            - sourceRef:
                generatorRef:
                  apiVersion: generators.external-secrets.io/v1alpha1
                  kind: ClusterGenerator
                  name: ascii-password-generator
              rewrite:
                - transform:
                    template: "bind_password"
      - apiVersion: v1
        kind: Secret
        type: Opaque
        metadata:
          name: authentik-blueprints
          namespace: "{{ .Values.applicationsNamespace }}"
        stringData:
          10-ldap.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: LDAP provider app outpost
            entries:
              # ---- Service Account ----
              - id: ldap-bind-user
                model: authentik_core.user
                identifiers:
                  username: ldapservice
                attrs:
                  name: "LDAP Service Account"
                  email: "ldapservice@{{ .Values.fqdn }}"
                  password: !File /blueprints/mounted/secret-ldap/bind_password
                  is_active: true
                  type: service_account

              # ---- Application ----
              - id: ldap-app
                model: authentik_core.application
                identifiers:
                  slug: ldap
                attrs:
                  name: LDAP
                  policy_engine_mode: any

              # ---- Stages ----
              - id: ldap-password
                model: authentik_stages_password.passwordstage
                identifiers:
                  name: "ldap-password"
                attrs:
                  backends:
                    - authentik.core.auth.InbuiltBackend
                    - authentik.core.auth.TokenBackend
                    - authentik.sources.ldap.auth.LDAPBackend
                    - authentik.sources.kerberos.auth.KerberosBackend

              - id: ldap-identification
                model: authentik_stages_identification.identificationstage
                identifiers:
                  name: "ldap-identification"
                attrs:
                  user_fields: ["username", "email"]
                  password_stage: !Find [authentik_stages_password.passwordstage, [name, ldap-password]]

              - id: ldap-user-login
                model: authentik_stages_user_login.userloginstage
                identifiers:
                  name: "ldap-user-login"
                attrs:
                  terminate_other_sessions: false

              # ---- Flows ----
              - id: ldap-auth-flow
                model: authentik_flows.flow
                identifiers:
                  slug: "ldap-authentication-flow"
                attrs:
                  name: "LDAP Authentication"
                  title: "Sign in"
                  designation: authentication
                  require_outpost: true

              # ---- Flow bindings ----
              - id: ldap-auth-flow-bind-ident
                model: authentik_flows.flowstagebinding
                identifiers:
                  target: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
                  stage:  !KeyOf ldap-identification
                  order: 10
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false

              - id: ldap-auth-flow-bind-login
                model: authentik_flows.flowstagebinding
                identifiers:
                  target: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
                  stage:  !KeyOf ldap-user-login
                  order: 30
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: false

              # ---- LDAP Provider ----
              - id: ldap-provider
                model: authentik_providers_ldap.ldapprovider
                identifiers:
                  name: "Provider for LDAP"
                attrs:
                  base_dn: "{{ include "ldap.base_dn" . }}"
                  bind_mode: cached
                  search_mode: direct
                  mfa_support: true
                  tls_server_name: ""
                  authorization_flow: !Find [authentik_flows.flow, [slug, ldap-authentication-flow]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                permissions:
                  - permission: search_full_directory
                    user: !Find [authentik_core.user, [username, ldapservice]]

              # ---- Attach Provider to Application ----
              - id: ldap-app-provider-link
                model: authentik_core.application
                identifiers:
                  slug: ldap
                attrs:
                  provider: !KeyOf ldap-provider

              # ---- LDAP Outpost ----
              - id: ldap-outpost
                model: authentik_outposts.outpost
                identifiers:
                  name: "LDAP outpost"
                attrs:
                  type: ldap
                  providers:
                    - !Find [authentik_providers_ldap.ldapprovider, [name, "Provider for LDAP"]]
                  service_connection: !Find [authentik_outposts.kubernetesserviceconnection, [name, "Local Kubernetes Cluster"]]
                  config:
                    authentik_host: "https://auth.{{ .Values.fqdn }}"
{{- if .Values.applications.immich.enabled }}
          50-immich.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Immich OAuth2 Provider
            entries:
              - id: immich-provider
                model: authentik_providers_oauth2.oauth2provider
                identifiers:
                  name: Provider for immich
                attrs:
                  authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                  client_type: confidential
                  redirect_uris:
                    - matching_mode: strict
                      url: "https://immich.{{ .Values.fqdn }}/auth/login"
                    - matching_mode: strict
                      url: "https://immich.{{ .Values.fqdn }}/user-settings"
                    - matching_mode: strict
                      url: "app.immich:///oauth-callback"
                  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
                  property_mappings:
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
              - id: immich-app
                model: authentik_core.application
                identifiers:
                  slug: immich
                attrs:
                  name: immich
                  provider: !KeyOf immich-provider
                  policy_engine_mode: any
{{- end }}
{{- if .Values.applications.nextcloud.enabled }}
          50-nextcloud.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Nextcloud OAuth2 Provider
            entries:
              - id: nextcloud-provider
                model: authentik_providers_oauth2.oauth2provider
                identifiers:
                  name: Provider for Nextcloud
                attrs:
                  authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                  client_type: confidential
                  sub_mode: user_username
                  redirect_uris: 
                    - matching_mode: strict
                      url: "https://nextcloud.{{ .Values.fqdn }}/apps/user_oidc/code"
                  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
                  property_mappings:
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

              - id: nextcloud-app
                model: authentik_core.application
                identifiers:
                  slug: nextcloud
                attrs:
                  name: Nextcloud
                  provider: !KeyOf nextcloud-provider
                  policy_engine_mode: any
{{- end }}
{{- if .Values.applications.stalwart.enabled }}
          50-stalwart.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Stalwart provisionning
            entries:
              - id: postmaster-mail
                model: authentik_core.group
                identifiers:
                  name: postmaster
                attrs:
                  attributes:
                    mailLocalAddress: "postmaster@{{ .Values.fqdn }}"

              - id: info-mail
                model: authentik_core.group
                identifiers:
                  name: info
                attrs:
                  attributes:
                    mailLocalAddress: "info@{{ .Values.fqdn }}"

              - id: stage-seed-mail
                model: authentik_stages_user_write.userwritestage
                identifiers:
                  name: "seed-mailLocalAddress-stage"
                attrs:
                  user_creation_mode: never_create
                  user_type: internal

              - id: policy-mailLocalAddress
                model: authentik_policies_expression.expressionpolicy
                identifiers:
                  name: "seed-mailLocalAddress-policy"
                attrs:
                  expression: |
                    u = request.user
                    if not u or not hasattr(u, "attributes"):
                      return True
                    attrs = dict(u.attributes or {})
                    local = u.username or ""
                    if (not local) and u.email and "@" in u.email:
                      local = u.email.split("@", 1)[0]
                    if not local:
                      return True
                    domain = "{{ .Values.fqdn }}"
                    alias = f"{local}@{domain}"
                    if not attrs.get("mailLocalAddress"):
                      attrs["mailLocalAddress"] = alias
                      u.attributes = attrs
                      u.save()
                    return True

              - id: bind-stage-to-auth
                model: authentik_flows.flowstagebinding
                identifiers:
                  stage: !Find [authentik_stages_user_write.userwritestage, [name, seed-mailLocalAddress-stage]]
                  target: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
                  order: 200
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: true

              - id: bind-policy-to-stage-to-auth
                model: authentik_policies.policybinding
                identifiers:
                  policy: !Find [authentik_policies_expression.expressionpolicy, [name, seed-mailLocalAddress-policy]]
                  target: !KeyOf bind-stage-to-auth
                  order: 0
                attrs:
                  enabled: true

              - id: bind-stage-to-source-auth
                model: authentik_flows.flowstagebinding
                identifiers:
                  stage: !Find [authentik_stages_user_write.userwritestage, [name, seed-mailLocalAddress-stage]]
                  target: !Find [authentik_flows.flow, [slug, default-source-authentication]]
                  order: 200
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: true

              - id: bind-policy-to-stage-to-source-auth
                model: authentik_policies.policybinding
                identifiers:
                  policy: !Find [authentik_policies_expression.expressionpolicy, [name, seed-mailLocalAddress-policy]]
                  target: !KeyOf bind-stage-to-source-auth
                  order: 0
                attrs:
                  enabled: true

              - id: bind-stage-to-enrollment
                model: authentik_flows.flowstagebinding
                identifiers:
                  stage: !Find [authentik_stages_user_write.userwritestage, [name, seed-mailLocalAddress-stage]]
                  target: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
                  order: 200
                attrs:
                  evaluate_on_plan: true
                  re_evaluate_policies: true

              - id: bind-policy-to-stage-to-enrollment
                model: authentik_policies.policybinding
                identifiers:
                  policy: !Find [authentik_policies_expression.expressionpolicy, [name, seed-mailLocalAddress-policy]]
                  target: !KeyOf bind-stage-to-enrollment
                  order: 0
                attrs:
                  enabled: true
{{- end }}
{{- if .Values.applications.stirling_pdf.enabled }}
          50-stirling-pdf.yaml: |
            # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
            version: 1
            metadata:
              name: Stirling-PDF OAuth2 Provider
            entries:
              - id: stirling-pdf-provider
                model: authentik_providers_oauth2.oauth2provider
                identifiers:
                  name: Provider for Stirling-PDF
                attrs:
                  authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
                  invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
                  client_type: confidential
                  redirect_uris:
                    - matching_mode: strict
                      url: "https://pdf.{{ .Values.fqdn }}/login/oauth2/code/oidc"
                  signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
                  property_mappings:
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
                    - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
              - id: stirling-pdf-app
                model: authentik_core.application
                identifiers:
                  slug: stirling-pdf
                attrs:
                  name: Stirling-PDF
                  provider: !KeyOf stirling-pdf-provider
                  policy_engine_mode: any
{{- end }}
      - apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: authentik-admin
          namespace: "{{ .Values.applicationsNamespace }}"
          annotations:
            homer.item.excluded: "true"
            traefik.ingress.kubernetes.io/router.middlewares: kube-system-intranet-allowlist@kubernetescrd
        spec:
          tls:
            - hosts:
                - auth.{{ .Values.fqdn }}
              secretName: "{{ .Values.fqdn }}-tls"
          rules:
            - host: auth.{{ .Values.fqdn }}
              http:
                paths:
                  - path: /if/admin
                    pathType: Prefix
                    backend:
                      service:
                        name: authentik-server
                        port:
                          number: 80

      - apiVersion: traefik.io/v1alpha1
        kind: Middleware
        metadata:
          name: authentik
          namespace: "{{ .Values.applicationsNamespace }}"
        spec:
          forwardAuth:
            address: http://ak-outpost-authentik-embedded-outpost.{{ .Values.applicationsNamespace }}.svc.cluster.local:9000/outpost.goauthentik.io/auth/traefik
            trustForwardHeader: true
            authResponseHeaders:
              - X-authentik-username
              - X-authentik-groups
              - X-authentik-entitlements
              - X-authentik-email
              - X-authentik-name
              - X-authentik-uid
              - X-authentik-jwt
              - X-authentik-meta-jwks
              - X-authentik-meta-outpost
              - X-authentik-meta-provider
              - X-authentik-meta-app
              - X-authentik-meta-version
{{- end }}
