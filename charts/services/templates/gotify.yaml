{{- if and (not .Values.disableAllApplications) .Values.applications.gotify.enabled }}
{{- if not .Values.applications.postgresql.enabled }}
{{- fail "Gotify requires PostgreSQL to be enabled. Please enable PostgreSQL in your values.yaml" }}
{{- end }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: gotify
  namespace: default
spec:
  chart: gotify
  repo: https://charts.gabe565.com
  version: 0.4.0
  targetNamespace: default
  valuesContent: |-
    controller:
      annotations:
        reloader.stakater.com/auto: "true"
    env:
      GOTIFY_DATABASE_DIALECT: postgres
      DATABASE_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: postgresql-pguser-gotify
            key: password
      GOTIFY_DATABASE_CONNECTION: host=postgresql-primary port=5432 user=gotify dbname=gotify password=$(DATABASE_PASSWORD)
      PGSSLMODE: verify-full
      PGSSLROOTCERT: /etc/postgres/tls/ca.crt
      PGSSLCERT: /etc/postgres/tls/tls.crt
      PGSSLKEY: /etc/postgres/tls/tls.key
    resources:
      requests:
        memory: 64Mi
        cpu: 250m
      limits:
        memory: 128Mi
    podSecurityContext:
      runAsUser: 0
      runAsGroup: 0
      fsGroup: 0
    persistence:
      postgres-tls:
        enabled: true
        type: secret
        name: postgresql-cluster-cert
        mountPath: /etc/postgres/tls
        defaultMode: 0400
    ingress:
      main:
        enabled: true
        annotations:
          homer.service.name: Feed
          homer.item.logo: "https://raw.githubusercontent.com/gotify/logo/87aef9091f51644eaccf78e7b67f8ce94271efeb/gotify-logo.png"
        hosts:
          - host: gotify.{{ .Values.fqdn }}
            paths:
              - path: /
        tls:
          - secretName: "{{ .Values.fqdn }}-tls"
            hosts:
              - gotify.{{ .Values.fqdn }}
    probes:
      liveness:
        spec:
          periodSeconds: 30
        type: HTTP
        path: /health
      readiness:
        spec:
          periodSeconds: 30
          initialDelaySeconds: 15
        type: HTTP
        path: /health
      startup:
        type: HTTP
        path: /health
{{- end }}
