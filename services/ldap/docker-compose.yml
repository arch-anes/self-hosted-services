version: "3.7"

services:
  openldap:
    image: osixia/openldap
    restart: always
    hostname: ldap.${DOMAIN_NAME}
    networks:
      - reverse_proxy
      - internal
    environment:
      - LDAP_TLS=false
      - LDAP_DOMAIN=${DOMAIN_NAME}
    env_file:
      - .env
    volumes:
      - ${STORAGE_LOCATION}/ldap/db:/var/lib/ldap
      - ${STORAGE_LOCATION}/ldap/config:/etc/ldap/slapd.d
    labels:
      - traefik.enable=true

      - traefik.tcp.services.openldap.loadbalancer.server.port=389

      - traefik.tcp.routers.openldap.rule=HostSNI(`*`)
      - traefik.tcp.routers.openldap.entrypoints=ldap
      - traefik.tcp.routers.openldap.service=openldap

      - traefik.tcp.routers.openldap-secure.rule=HostSNI(`*`)
      - traefik.tcp.routers.openldap-secure.service=openldap
      - traefik.tcp.routers.openldap-secure.entrypoints=ldapsecure
      - traefik.tcp.routers.openldap-secure.tls.certresolver=leresolver

  phpLDAPadmin:
    image: osixia/phpldapadmin
    restart: always
    networks:
      - reverse_proxy
      - internal
    environment:
      - PHPLDAPADMIN_HTTPS=false
      - "PHPLDAPADMIN_LDAP_HOSTS=#PYTHON2BASH:[{'ldap.${DOMAIN_NAME}': [{'server': [{'tls': False}]},{'login': [{'bind_id': 'cn=admin,${LDAP_DC}'}]}]}]"
    env_file:
      - .env
    depends_on:
      - openldap
    labels:
      - traefik.enable=true
      - traefik.http.routers.phpldapadmin.rule=Host(`ldap.${DOMAIN_NAME}`)
      - traefik.http.routers.phpldapadmin.tls.certresolver=leresolver
      - traefik.http.routers.phpldapadmin.entrypoints=websecure

networks:
  internal:
  reverse_proxy:
    external: true
