version: "3.7"

services:
  openldap:
    image: osixia/openldap
    restart: always
    hostname: openldap
    networks:
      - ldap
    ports:
      - 389:389
    environment:
      - LDAP_TLS=false
      - LDAP_DOMAIN=${DOMAIN_NAME}
    env_file:
      - .env
    volumes:
      - ${STORAGE_LOCATION}/ldap/db:/var/lib/ldap
      - ${STORAGE_LOCATION}/ldap/config:/etc/ldap/slapd.d

  phpLDAPadmin:
    image: osixia/phpldapadmin
    restart: always
    networks:
      - ldap
      - reverse_proxy
    environment:
      - PHPLDAPADMIN_HTTPS=false
      - "PHPLDAPADMIN_LDAP_HOSTS=#PYTHON2BASH:[{'${DOMAIN_NAME}': [{'server': [{'host': 'openldap'}, {'tls': False}]},{'login': [{'bind_id': 'cn=admin,${LDAP_DC}'}]}]}]"
    env_file:
      - .env
    depends_on:
      - openldap
    labels:
      - traefik.enable=true
      - traefik.http.routers.phpldapadmin.rule=Host(`ldap.${DOMAIN_NAME}`)
      - traefik.http.routers.phpldapadmin.tls.certresolver=leresolver
      - traefik.http.routers.phpldapadmin.entrypoints=websecure

networks:
  ldap:
    external: true
  reverse_proxy:
    external: true
