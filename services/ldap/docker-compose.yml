version: "3.7"

services:
  openldap:
    image: osixia/openldap
    restart: always
    hostname: ldap.${DOMAIN_NAME}
    networks:
      - reverse_proxy
      - internal
    environment:
      - LDAP_TLS=false
    env_file:
      - .env
    volumes:
      - ${STORAGE_LOCATION}/ldap/db:/var/lib/ldap
      - ${STORAGE_LOCATION}/ldap/config:/etc/ldap/slapd.d
    labels:
      - traefik.enable=true
      - traefik.tcp.routers.openldap.rule=HostSNI(`ldap.${DOMAIN_NAME}`)
      - traefik.tcp.routers.openldap.tls.certresolver=leresolver
      - traefik.tcp.routers.openldap.entrypoints=ldapsecure

  phpLDAPadmin:
    image: osixia/phpldapadmin
    restart: always
    networks:
      - reverse_proxy
      - internal
    environment:
      - PHPLDAPADMIN_HTTPS=false
      - PHPLDAPADMIN_LDAP_HOSTS=openldap
    env_file:
      - .env
    depends_on:
      - openldap
    labels:
      - traefik.enable=true
      - traefik.http.routers.phpldapadmin.rule=Host(`ldap.${DOMAIN_NAME}`)
      - traefik.http.routers.phpldapadmin.tls.certresolver=leresolver
      - traefik.http.routers.phpldapadmin.entrypoints=websecure

networks:
  internal:
  reverse_proxy:
    external: true
