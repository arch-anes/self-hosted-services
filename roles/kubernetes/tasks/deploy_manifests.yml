# code: language=ansible
---

- name: Deploy packages and manifests
  block:
    - name: Install packages
      block:
        - name: "Install Helm packages"
          include_tasks: install_helm_package.yml
          with_fileglob: "{{ packages_location }}/*.yml"
          loop_control:
            loop_var: package_file

        - name: "Install URL packages"
          command: "kubectl apply -f {{ lookup('file', package_file) }}"
          with_fileglob: "{{ packages_location }}/*.url"
          loop_control:
            loop_var: package_file

    - name: Deploy Kubernetes manifests
      block:
        - name: Generate aggregate manifest file
          shell: "cat {{ manifests_location }}/*.yml | env DOMAIN_NAME={{ fqdn }} envsubst '$DOMAIN_NAME' > {{ aggregate_manifest_location }}"
          delegate_to: localhost
          run_once: true
          become: false

        - name: Copy aggregate file to remote
          copy:
            src: "{{ aggregate_manifest_location }}"
            dest: "{{ remote_manifest_location }}"
            mode: "0600"

        - name: Apply aggregate manifest
          command: "kubectl apply -f {{ remote_manifest_location }}"
  become: true
  run_once: true
