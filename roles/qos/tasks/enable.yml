---
- name: Disable Flow Offloading (Required for SQM)
  notify: Reload firewall
  community.openwrt.uci:
    command: set
    key: "firewall.@defaults[0].{{ item }}"
    value: '0'
    autocommit: true
  loop:
    - flow_offloading_hw
    - flow_offloading

- name: Enable SQM
  notify: Reload sqm
  community.openwrt.uci:
    command: section
    config: sqm
    type: queue
    name: "ansible_wan"
    value:
      enabled: '1'
      interface: "{{ ansible_wan_interface }}"
      download: "{{ qos.download_kbps }}"
      upload: "{{ qos.upload_kbps }}"
      qdisc: 'fq_codel'
      script: 'simple.qos'
      linklayer: 'ethernet'
      squash_dscp: '1'
      squash_ingress: '1'
      ingress_ecn: 'ECN'
      egress_ecn: 'ECN'
      qdisc_advanced_run: '1'
      qdisc_really_really_advanced_opts: 'nat dual-dsthost dual-srchost'
    autocommit: true
