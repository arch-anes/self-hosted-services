- name: Setup firewall
  import_role:
    name: weareinteractive.ufw
  vars:
    ufw_rules:
      - { to_port: "3210:3214", proto: udp, rule: allow, comment: "VPNCloud (15 static peers)" }

- name: Generate random password for VPN connection
  set_fact:
    vpn_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits') }}"
  when: "inventory_hostname == ansible_play_hosts[0]"

- name: Propagate password to other hosts
  set_fact:
    vpn_password: "{{ hostvars[ansible_play_hosts[0]]['vpn_password'] }}"
  when: "inventory_hostname != ansible_play_hosts[0]"

- name: Get host public IP
  ipify_facts:

- name: Set host private IP address
  set_fact:
    listen_vpn_port: "{{vpn_port | default(3210)}}"
    private_ip: "{{ vpn_ip | default('10.10.10.' + ((ansible_play_hosts_all.index(inventory_hostname) + 20) | string))}}"

- name: Set peer list
  set_fact:
    peers: "{{ peers | default('') + ' -c ' + hostvars[item]['ipify_public_ip'] + ':' + hostvars[item]['listen_vpn_port'] }}"
  loop: "{{ ansible_play_hosts }}"

- name: Create systemd service
  template:
    src: vpncloud.service.j2
    dest: /usr/lib/systemd/system/vpncloud.service

- name: Start systemd service
  systemd:
    name: vpncloud
    daemon_reload: yes
    state: restarted
    enabled: yes
