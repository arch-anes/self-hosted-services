version: "3"

services:
  app:
    image: mayanedms/mayanedms
    networks:
      - ldap
      - reverse_proxy
      - internal
    volumes:
      - ${STORAGE_LOCATION}/mayanedms/app:/var/lib/mayan
    environment:
      MAYAN_CELERY_BROKER_URL: redis://:${MAYAN_REDIS_PASSWORD}@results:6379/0
      MAYAN_CELERY_RESULT_BACKEND: redis://:${MAYAN_REDIS_PASSWORD}@results:6379/1
      MAYAN_DATABASES: "{'default':{'ENGINE':'django.db.backends.postgresql','NAME':'mayan','PASSWORD':'${MAYAN_DATABASE_PASSWORD}','USER':'mayan','HOST':'db'}}"
      MAYAN_DOCKER_WAIT: "db:5432 results:6379"
    depends_on:
      - db
      - results
    deploy:
      placement:
        constraints:
          - node.labels.big==true
      labels:
        - traefik.enable=true
        - traefik.http.routers.mayanedms.rule=Host(`mayanedms.${DOMAIN_NAME}`)
        - traefik.http.routers.mayanedms.tls.certresolver=leresolver
        - traefik.http.routers.mayanedms.entrypoints=websecure
        - traefik.http.services.mayanedms.loadbalancer.server.port=8000

  db:
    image: postgres:12-alpine
    networks:
      - internal
    environment:
      - POSTGRES_DB=mayan
      - POSTGRES_PASSWORD=${MAYAN_DATABASE_PASSWORD}
      - POSTGRES_USER=mayan
    volumes:
      - ${STORAGE_LOCATION}/mayanedms/db:/var/lib/postgresql/data
    deploy:
      placement:
        constraints:
          - node.labels.big==true

  results:
    image: redis:5.0-alpine
    networks:
      - internal
    command:
      - redis-server
      - --appendonly
      - "no"
      - --databases
      - "2"
      - --maxmemory
      - "100mb"
      - --maxclients
      - "500"
      - --maxmemory-policy
      - "allkeys-lru"
      - --save
      - ""
      - --tcp-backlog
      - "256"
      - --requirepass
      - "${MAYAN_REDIS_PASSWORD}"
    volumes:
      - ${STORAGE_LOCATION}/mayanedms/redis:/data
    deploy:
      placement:
        constraints:
          - node.labels.big==true

networks:
  internal:
  ldap:
    external: true
  reverse_proxy:
    external: true
